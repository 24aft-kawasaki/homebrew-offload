# zshとzsh-completionsはイメージにプリインストールされている
echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.zshrc

git merge-file -p ~/.zshrc /workspaces/homebrew-offload/completion/.zshrcbase /workspaces/homebrew-offload/completion/.zshrc > /dev/null || (echo "Merge conflict between ~/.zshrc and /workspaces/homebrew-offload/completion/.zshrc" 1>&2 && exit 1) && git merge-file ~/.zshrc /workspaces/homebrew-offload/completion/.zshrcbase /workspaces/homebrew-offload/completion/.zshrc

fpath=( /workspaces/homebrew-offload/comp $fpath )
rm ~/.zcompdump* # 補完のキャッシュの削除

# zshの補完で使うためには、ディレクトリ(親以上も含む)と関数定義ファイルのパーミッションが、自分以外に書き込み権限がないようにしなければ、compinit時点でfpathから削除されてしまう
bash -c 'comp=/workspaces/homebrew-offload/completion/.zshrc; IFS="/"; current=""; for p in ${comp#/}; do current="$current/$p"; echo "$current"; done | xargs chmod go-w'

TAP=24aft-kawasaki/homebrew-offload

brew tap-new $TAP

brew create --set-name=brew-offload --tap=$TAP https://github.com/24aft-kawasaki/homebrew-offload/archive/refs/tags/v0.0.0.tar.gz


HOMEBREW_NO_INSTALL_FROM_API=1 brew audit --new brew-offload
HOMEBREW_NO_INSTALL_FROM_API=1 brew install --build-from-source --verbose --debug brew-offload


brew tap 24aft-kawasaki/homebrew-offload
brew install 24aft-kawasaki/homebrew-offload/brew-offload

# matrixを並列実行する場合
act push -e .github/events/push-with-tag.json
# matrixを一つだけ指定する場合(--matrixの引数には''を付ける必要あり)
act push -e .github/events/push-with-tag.json --matrix 'python-version:3.9'

tar czvf /tmp/brew-offload.tar.gz -C /workspaces/ homebrew-offload
sha256sum /tmp/brew-offload.tar.gz

sudo apt-get update
sudo apt-get upgrade

brew update
brew upgrade

brew install gcc

brew tap-new user/repo
brew create file:///tmp/brew-offload.tar.gz --tap=user/repo --set-name=brew-offload --set-version=0.0.1

TAP=$(brew --repository user/repo)
rm -rf $TAP/*
cp -R . $TAP

brew audit --strict brew-offload

chmod +t /tmp/brew_template/brew/Library/Homebrew/vendor/bundle/ruby/3.4.0/gems

HOMEBREW_NO_INSTALL_FROM_API=1 brew install --verbose --formula --debug $TAP/brew-offload.rb
